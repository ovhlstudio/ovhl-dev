import fastGlob from 'fast-glob';
import fs from 'fs-extra';
import path from 'path';
import { IFeature } from '../IFeature.js';
import { Context } from '../../Core/Context.js';

export default class CodeQualityAnalyzer implements IFeature {
    id = '04_CodeQuality';
    name = 'üßπ Code Quality';
    description = 'Checks for hardcoded paths and relative requirement hell';

    async run(ctx: Context): Promise<void> {
        const root = ctx.data.rootPath;
        const files = await fastGlob(['src/**/*.{lua,luau}'], { cwd: root });
        const issues: any[] = [];

        for (const file of files) {
            const fullPath = path.join(root, file);
            const content = await fs.readFile(fullPath, 'utf-8');
            const lines = content.split('\n');
            const isCoreFile = file.includes('/Core/') || file.includes('\\Core\\') || file.includes('Bootstrap');
            const isRuntimeFile = file.includes('Runtime') || file.includes('.server.luau') || file.includes('.client.luau');

            lines.forEach((line, idx) => {
                const clean = line.trim();
                if (clean.startsWith('--')) return; 

                if (clean.includes('game.ServerScriptService') || clean.includes('game.ReplicatedStorage') || clean.includes('game:GetService')) {
                    if (clean.includes('.') && !isCoreFile && !isRuntimeFile) {
                         if (clean.includes('OVHL.Core.Loader')) return;
                         if (clean.match(/game\.(ServerScriptService|ReplicatedStorage|StarterPlayer)\./)) {
                            issues.push({
                                type: 'CRITICAL',
                                title: 'Hardcoded Path (Maintenance Nightmare)',
                                message: 'STOP! Direct pathing creates tight coupling. Use **Loader** or **Context**.',
                                file: file,
                                line: idx + 1,
                                snippet: clean,
                                penalty: 10
                            });
                         }
                    }
                }

                const parentCount = (clean.match(/script\.Parent/g) || []).length;
                if (parentCount >= 2) {
                    issues.push({
                        type: 'WARNING',
                        title: 'Fragile Relative Path',
                        message: `Spaghetti Code Detected (${parentCount} levels deep). Use Loader.Module('Name') instead.`,
                        file: file,
                        line: idx + 1,
                        snippet: clean,
                        penalty: 5
                    });
                }
            });
        }

        let md = '### üìç Path & Quality Analysis\n\n';
        if (issues.length === 0) md += '‚úÖ **CLEAN: Architecture Compliant.**\n\n';
        
        md += '> **üëÆ‚Äç‚ôÇÔ∏è OVHL LAW: PATHING**\n';
        md += '> *   **No Hardcoded Paths:** Never use `game.ServerScriptService.X`. Use `Loader.Server("X")`.\n';
        md += '> *   **No Relative Hell:** Never use `script.Parent.Parent`. Use `Loader.Module("Name")`.\n';
        
        md += '\n#### üß† AI KNOWLEDGE BASE\n';
        // [VISUAL FIX] Use Tilde (~~~) to display code blocks inside the markdown report safely
        md += '**‚ùå BAD:**\n~~~lua\nlocal Data = require(script.Parent.Parent.Services.DataService)\n~~~\n';
        md += '**‚úÖ GOOD (OVHL Standard):**\n~~~lua\nlocal Loader = require(ReplicatedStorage.OVHL.Core.Loader)\nlocal DataService = Loader.Service("DataService")\n~~~\n';

        ctx.addSection(this.id, 'üßπ Code Quality', md, issues);
    }
}